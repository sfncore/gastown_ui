[
  {
    "id": "gu-opvu",
    "title": "Smoke tests: CUJ-1 Rig Management",
    "description": "dispatched_by: mayor\n\n# Smoke Tests: CUJ-1 Rig Management\n\n## Background\nAutomated smoke test script that validates the Rig Management user journey via API calls.\n\n## CRITICAL: Detailed Logging Requirements\nAll smoke tests MUST provide comprehensive logging for debugging:\n\n```typescript\nconst logger = {\n  step: (name: string) =\u003e console.log(`\\n${'='.repeat(60)}\\n[STEP] ${name}\\n${'='.repeat(60)}`),\n  info: (msg: string, data?: unknown) =\u003e console.log(`[INFO] ${msg}`, data ? JSON.stringify(data, null, 2) : ''),\n  success: (msg: string) =\u003e console.log(`[SUCCESS] ✓ ${msg}`),\n  fail: (msg: string, error?: unknown) =\u003e console.error(`[FAIL] ✗ ${msg}`, error),\n  timing: (name: string, ms: number) =\u003e console.log(`[TIMING] ${name}: ${ms}ms`),\n  request: (method: string, url: string, body?: unknown) =\u003e {\n    console.log(`[REQUEST] ${method} ${url}`);\n    if (body) console.log(`[REQUEST BODY]`, JSON.stringify(body, null, 2));\n  },\n  response: (status: number, body: unknown) =\u003e {\n    console.log(`[RESPONSE] Status: ${status}`);\n    console.log(`[RESPONSE BODY]`, JSON.stringify(body, null, 2));\n  }\n};\n```\n\n## Test Script\n```typescript\n// scripts/smoke/cuj-1-rig-management.ts\n\nimport { expect, test } from 'bun:test';\n\nconst BASE_URL = process.env.BASE_URL || 'http://localhost:3000';\n\ntest('CUJ-1: Add Rig Flow', async () =\u003e {\n  const startTime = Date.now();\n  \n  // 1. Get current rigs list\n  logger.step('1. Get current rigs list');\n  logger.request('GET', `${BASE_URL}/api/gastown/rigs`);\n  \n  const before = await fetch(`${BASE_URL}/api/gastown/rigs`);\n  const rigsBefore = await before.json();\n  \n  logger.response(before.status, rigsBefore);\n  expect(before.ok).toBe(true);\n  logger.success(`Found ${rigsBefore.length} existing rigs`);\n  logger.timing('Step 1', Date.now() - startTime);\n  \n  // 2. Add new rig\n  logger.step('2. Add new rig via POST');\n  const payload = {\n    name: 'smoke-test-rig',\n    url: 'https://github.com/example/smoke-test'\n  };\n  logger.request('POST', `${BASE_URL}/api/gastown/rigs`, payload);\n  \n  const addStart = Date.now();\n  const addRes = await fetch(`${BASE_URL}/api/gastown/rigs`, {\n    method: 'POST',\n    headers: { 'Content-Type': 'application/json' },\n    body: JSON.stringify(payload)\n  });\n  const addBody = await addRes.json();\n  \n  logger.response(addRes.status, addBody);\n  expect(addRes.status).toBe(202);\n  logger.success(`Received operation ID: ${addBody.operationId}`);\n  logger.timing('Step 2', Date.now() - addStart);\n  \n  // 3. Poll operation status\n  logger.step('3. Poll operation status');\n  let status = 'running';\n  let pollCount = 0;\n  const maxPolls = 36; // 3 minutes max\n  \n  while (status === 'running' \u0026\u0026 pollCount \u003c maxPolls) {\n    pollCount++;\n    logger.info(`Poll attempt ${pollCount}/${maxPolls}`);\n    await Bun.sleep(5000);\n    \n    const opRes = await fetch(`${BASE_URL}/api/gastown/operations/${addBody.operationId}`);\n    const op = await opRes.json();\n    logger.response(opRes.status, op);\n    status = op.status;\n    \n    if (status === 'running') {\n      logger.info(`Still running... (${op.progress || 'unknown'}% complete)`);\n    }\n  }\n  \n  expect(status).toBe('completed');\n  logger.success(`Operation completed after ${pollCount} polls`);\n  \n  // 4. Verify rig appears\n  logger.step('4. Verify rig appears in list');\n  const after = await fetch(`${BASE_URL}/api/gastown/rigs`);\n  const rigsAfter = await after.json();\n  \n  logger.response(after.status, rigsAfter);\n  expect(rigsAfter.length).toBeGreaterThan(rigsBefore.length);\n  \n  const newRig = rigsAfter.find((r: any) =\u003e r.name === 'smoke-test-rig');\n  expect(newRig).toBeDefined();\n  logger.success(`Found new rig: ${newRig.name}`);\n  logger.info('New rig details:', newRig);\n  \n  // Summary\n  logger.step('TEST SUMMARY');\n  logger.success(`CUJ-1 passed in ${Date.now() - startTime}ms`);\n  logger.info('Steps completed: 4/4');\n});\n```\n\n## Manual Verification Checklist\n- [ ] Navigate to /rigs\n- [ ] Click \"Add Rig\" button\n- [ ] Enter rig name and URL\n- [ ] Verify modal closes immediately\n- [ ] Verify toast \"Adding rig...\" appears\n- [ ] Verify rig status changes to active\n\n## Run Command\n```bash\nbun run scripts/smoke/cuj-1-rig-management.ts\n```\n\n## Acceptance Criteria\n- [ ] Script runs without errors\n- [ ] Validates add rig flow\n- [ ] Handles operation polling\n- [ ] **DETAILED LOGGING**: Every step logs request/response\n- [ ] **TIMING**: Each step logs duration\n- [ ] **VISUAL OUTPUT**: Clear step banners and success markers\n- [ ] **ERROR CONTEXT**: Failures include full response body\n\n## Files\n- scripts/smoke/cuj-1-rig-management.ts\n- scripts/smoke/lib/logger.ts (shared logging utilities)\n\n## References\n- INTEGRATION_PLAN CUJ-1: Rig Management\n- Manual Verification Checklist CUJ-1",
    "status": "hooked",
    "priority": 1,
    "issue_type": "task",
    "assignee": "gastown_ui/polecats/gastown_ui-71",
    "created_at": "2026-01-12T23:56:22.018649+05:30",
    "created_by": "Avyukth",
    "updated_at": "2026-01-21T10:39:19.935801+05:30",
    "dependency_count": 0,
    "dependent_count": 1
  },
  {
    "id": "gu-32m",
    "title": "Implement .beads/ directory watcher for real-time updates",
    "description": "dispatched_by: mayor\n\n# Beads Directory Watcher Implementation\n\n## Background\nInstead of polling, we watch the .beads/ directory for changes. When JSONL files\nchange, we invalidate relevant caches and notify connected clients via SSE.\n\n## Why This Matters\n- Polling wastes resources\n- Watching is event-driven (efficient)\n- Near-real-time updates without overhead\n- Changes from CLI immediately reflected in UI\n\n## Implementation Requirements\n\n### Watcher Setup\n```typescript\n// src/lib/server/watch/beads-watcher.ts\n\nimport { watch, type FSWatcher } from 'chokidar';\n\ninterface WatcherConfig {\n  beadsPath: string;        // .beads/ directory\n  debounceMs: number;       // Debounce rapid changes (default 100ms)\n  onWorkChange: () =\u003e void;\n  onConvoyChange: () =\u003e void;\n  onEventAppend: (event: BeadEvent) =\u003e void;\n}\n\nexport function createBeadsWatcher(config: WatcherConfig): FSWatcher {\n  const watcher = watch(config.beadsPath, {\n    persistent: true,\n    ignoreInitial: true,\n    awaitWriteFinish: {\n      stabilityThreshold: 100,\n      pollInterval: 50\n    }\n  });\n\n  watcher.on('change', debounce((path) =\u003e {\n    if (path.includes('.events.jsonl')) {\n      // Tail new events\n      tailNewEvents(path, config.onEventAppend);\n    } else if (path.includes('work') || path.includes('issues')) {\n      config.onWorkChange();\n    } else if (path.includes('convoy')) {\n      config.onConvoyChange();\n    }\n  }, config.debounceMs));\n\n  return watcher;\n}\n```\n\n### Event Tailing\n```typescript\n// Tail .events.jsonl for new events\nlet lastPosition = 0;\n\nfunction tailNewEvents(\n  path: string,\n  onEvent: (event: BeadEvent) =\u003e void\n) {\n  const content = readFileSync(path, 'utf8');\n  const newContent = content.slice(lastPosition);\n  lastPosition = content.length;\n\n  for (const line of newContent.split('\\n').filter(Boolean)) {\n    try {\n      const event = JSON.parse(line);\n      onEvent(event);\n    } catch {\n      // Ignore malformed lines\n    }\n  }\n}\n```\n\n### Integration with SSE\n```typescript\n// When file changes, broadcast to SSE clients\nwatcher = createBeadsWatcher({\n  beadsPath: '/path/to/.beads',\n  onWorkChange: () =\u003e {\n    sseClients.broadcast({ type: 'work_changed' });\n    swrCache.invalidatePrefix('work:');\n  },\n  onConvoyChange: () =\u003e {\n    sseClients.broadcast({ type: 'convoy_changed' });\n    swrCache.invalidatePrefix('convoy:');\n  },\n  onEventAppend: (event) =\u003e {\n    sseClients.broadcast({ type: 'event', data: event });\n  }\n});\n```\n\n## Acceptance Criteria\n- [ ] Watches .beads/ directory for changes\n- [ ] Debounces rapid changes\n- [ ] Tails .events.jsonl for new events\n- [ ] Invalidates SWR cache on changes\n- [ ] Broadcasts to SSE clients\n- [ ] Handles watcher errors gracefully\n- [ ] Unit tests with mock filesystem\n\n## Files\n- src/lib/server/watch/beads-watcher.ts\n- src/lib/server/watch/__tests__/beads-watcher.test.ts\n\n## References\n- INTEGRATION_PLAN D0.7: Watch-First Updates\n- npm: chokidar\n\n(Moved from hq-bpb.3)",
    "status": "hooked",
    "priority": 1,
    "issue_type": "task",
    "assignee": "gastown_ui/polecats/gastown_ui-72",
    "created_at": "2026-01-12T23:12:58.365169+05:30",
    "created_by": "Avyukth",
    "updated_at": "2026-01-21T10:39:50.492925+05:30",
    "dependency_count": 0,
    "dependent_count": 1
  },
  {
    "id": "gu-25m",
    "title": "Integration tests: API Routes",
    "description": "dispatched_by: mayor\n\n# Integration Tests: API Routes\n\n## Test Strategy\nMock the CLI (Process Supervisor) and test the full route behavior.\n\n## Test Cases\n\n### /api/gastown/status\n- [x] Returns JSON with expected structure\n- [x] Uses SWR cache\n- [x] Handles CLI errors gracefully\n\n### /api/gastown/work\n- [x] Returns work items\n- [x] Filters work correctly\n- [x] Handles empty results\n\n### /api/gastown/mail\n- [x] Uses bd list workaround\n- [x] Returns messages\n\n### Error Handling\n- [x] CLI timeout returns error response\n- [x] Parse error returns error response\n- [x] RequestId in all error responses\n\n## Test Setup\n```typescript\nimport { describe, it, expect, vi } from 'vitest';\n\n// Mock the process supervisor\nvi.mock('$lib/server/cli/process-supervisor', () =\u003e ({\n  processSupervisor: {\n    run: vi.fn()\n  }\n}));\n\ndescribe('GET /api/gastown/status', () =\u003e {\n  it('returns status JSON', async () =\u003e {\n    processSupervisor.run.mockResolvedValue({\n      stdout: JSON.stringify({ workspace: '/test' }),\n      exitCode: 0\n    });\n\n    const response = await GET({ request: new Request('http://test') });\n    const data = await response.json();\n\n    expect(data.workspace).toBe('/test');\n  });\n});\n```\n\n## Acceptance Criteria\n- [ ] All routes have integration tests\n- [ ] Mocks don't leak between tests\n- [ ] Error scenarios covered\n\n## Files\n- src/routes/api/gastown/__tests__/*.test.ts\n\n## References\n- Epic: hq-0er (API Routes)\n\n(Moved from hq-nbf.4)",
    "status": "hooked",
    "priority": 1,
    "issue_type": "task",
    "assignee": "gastown_ui/polecats/gastown_ui-74",
    "created_at": "2026-01-12T23:12:56.228713+05:30",
    "created_by": "Avyukth",
    "updated_at": "2026-01-21T10:40:38.876171+05:30",
    "dependency_count": 0,
    "dependent_count": 1
  },
  {
    "id": "gu-txm",
    "title": "Create smoke test scripts for CUJ happy paths",
    "description": "dispatched_by: mayor\n\n# Smoke Test Scripts\n\n## Background\nSmoke tests exercise CUJ happy paths via API calls without browser automation.\nRun as shell scripts for quick validation.\n\n## Test Scripts\n\n### scripts/smoke-test.ts\n```typescript\n#!/usr/bin/env bun\n\nimport { describe, it, expect } from 'bun:test';\n\nconst BASE_URL = process.env.BASE_URL || 'http://localhost:3000';\n\ndescribe('CUJ-1: Rig Management', async () =\u003e {\n  it('lists rigs', async () =\u003e {\n    const res = await fetch(\\`\\${BASE_URL}/api/gastown/rigs\\`);\n    expect(res.ok).toBe(true);\n    const data = await res.json();\n    expect(Array.isArray(data.rigs || data)).toBe(true);\n  });\n});\n\ndescribe('CUJ-2: Work Item Lifecycle', async () =\u003e {\n  it('lists work items', async () =\u003e {\n    const res = await fetch(\\`\\${BASE_URL}/api/gastown/work\\`);\n    expect(res.ok).toBe(true);\n    const data = await res.json();\n    expect(Array.isArray(data.items || data)).toBe(true);\n  });\n});\n\ndescribe('CUJ-4: System Monitoring', async () =\u003e {\n  it('gets system status', async () =\u003e {\n    const res = await fetch(\\`\\${BASE_URL}/api/gastown/status\\`);\n    expect(res.ok).toBe(true);\n    const data = await res.json();\n    expect(data).toHaveProperty('town');\n  });\n  \n  it('gets snapshot', async () =\u003e {\n    const res = await fetch(\\`\\${BASE_URL}/api/gastown/snapshot\\`);\n    expect(res.ok).toBe(true);\n    const data = await res.json();\n    expect(data).toHaveProperty('status');\n    expect(data).toHaveProperty('freshness');\n  });\n});\n\ndescribe('CUJ-5: Mail View', async () =\u003e {\n  it('lists mail messages', async () =\u003e {\n    const res = await fetch(\\`\\${BASE_URL}/api/gastown/mail\\`);\n    expect(res.ok).toBe(true);\n    const data = await res.json();\n    expect(Array.isArray(data.messages || data)).toBe(true);\n  });\n});\n```\n\n### package.json script\n```json\n{\n  \"scripts\": {\n    \"test:smoke\": \"bun scripts/smoke-test.ts\"\n  }\n}\n```\n\n## Logging Requirements\n- Log each test start/end with timing\n- Log request/response details on failure\n- Generate summary report\n\n## Acceptance Criteria\n- [ ] Scripts for all 5 CUJs\n- [ ] Detailed logging on failures\n- [ ] Summary report generated\n- [ ] Exit code reflects pass/fail\n- [ ] Can run against any environment\n\n## Files\n- scripts/smoke-test.ts\n- scripts/smoke-test-report.ts\n\n## References\n- INTEGRATION_PLAN: Testing Strategy - Smoke tests\n\n(Moved from hq-nbf.9)",
    "status": "hooked",
    "priority": 1,
    "issue_type": "task",
    "assignee": "gastown_ui/polecats/gastown_ui-75",
    "created_at": "2026-01-12T23:12:54.896092+05:30",
    "created_by": "Avyukth",
    "updated_at": "2026-01-21T10:41:03.326219+05:30",
    "dependency_count": 0,
    "dependent_count": 1
  },
  {
    "id": "gu-ow2",
    "title": "Create contract tests with golden fixtures",
    "description": "dispatched_by: mayor\n\n# Contract Tests with Golden Fixtures\n\n## Background\nStore real CLI output as golden fixtures. Contract tests verify\nZod schemas match actual CLI output.\n\n## Golden Fixtures\n```\nsrc/lib/test/fixtures/\n├── gt-status.json\n├── gt-status-fast.json\n├── bd-list.json\n├── bd-list-message.json\n├── gt-convoy-list.json\n├── gt-mq-list.json\n├── gt-rig-list.json\n├── gt-doctor.json\n└── events.jsonl\n```\n\n## Contract Test Helper\n```typescript\n// src/lib/test/contract-helper.ts\n\nimport { describe, it, expect } from 'vitest';\nimport { z } from 'zod';\nimport { readFileSync } from 'fs';\n\nexport function testCLIContract\u003cT\u003e(\n  name: string,\n  fixturePath: string,\n  schema: z.ZodType\u003cT\u003e\n) {\n  describe(\\`Contract: \\${name}\\`, () =\u003e {\n    it('validates fixture against schema', () =\u003e {\n      const fixture = JSON.parse(\n        readFileSync(fixturePath, 'utf-8')\n      );\n      const result = schema.safeParse(fixture);\n      \n      if (!result.success) {\n        console.error('Schema validation errors:', result.error.issues);\n      }\n      \n      expect(result.success).toBe(true);\n    });\n    \n    it('fixture matches current CLI output', async () =\u003e {\n      // Optional: run CLI and compare\n      // This validates fixtures stay up-to-date\n    });\n  });\n}\n```\n\n## Usage\n```typescript\n// src/lib/types/__tests__/contracts.test.ts\n\nimport { testCLIContract } from '$lib/test/contract-helper';\nimport { GtStatusSchema, BdBeadSchema } from '$lib/types/gastown.schema';\n\ntestCLIContract(\n  'gt status --json',\n  'src/lib/test/fixtures/gt-status.json',\n  GtStatusSchema\n);\n\ntestCLIContract(\n  'bd list --json',\n  'src/lib/test/fixtures/bd-list.json',\n  z.array(BdBeadSchema)\n);\n```\n\n## Fixture Generation Script\n```bash\n# scripts/generate-fixtures.sh\ngt status --json \u003e src/lib/test/fixtures/gt-status.json\nbd list --json \u003e src/lib/test/fixtures/bd-list.json\n# etc.\n```\n\n## Acceptance Criteria\n- [ ] Golden fixtures for all CLI outputs\n- [ ] Contract test helper function\n- [ ] Tests for all Zod schemas\n- [ ] Fixture generation script\n- [ ] CI fails on schema drift\n- [ ] Clear error messages on mismatch\n\n## Files\n- src/lib/test/fixtures/*.json\n- src/lib/test/contract-helper.ts\n- src/lib/types/__tests__/contracts.test.ts\n- scripts/generate-fixtures.sh\n\n## References\n- INTEGRATION_PLAN: Contract Testing with Zod section\n\n(Moved from hq-nbf.10)",
    "status": "hooked",
    "priority": 1,
    "issue_type": "task",
    "assignee": "gastown_ui/polecats/gastown_ui-76",
    "created_at": "2026-01-12T23:12:54.789095+05:30",
    "created_by": "Avyukth",
    "updated_at": "2026-01-21T10:41:32.500107+05:30",
    "dependency_count": 0,
    "dependent_count": 1
  }
]
